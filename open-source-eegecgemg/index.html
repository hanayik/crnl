<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#2D2D2D" />
  
  <title>Chris Rordens Neuropsychology Lab :: DIY Electrophysiology</title>
  

  <link rel="icon" type="image/png" sizes="32x32" href="../_static/img/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../_static/img/favicon-16x16.png">
        <link rel="index" title="Index"
              href="../genindex.html"/>

  <link rel="stylesheet" href="../_static/css/insegel.css"/>

  <script type="text/javascript">
    var DOCUMENTATION_OPTIONS = {
        URL_ROOT:'',
        VERSION:'0.1',
        LANGUAGE:'None',
        COLLAPSE_INDEX:false,
        FILE_SUFFIX:'.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
    };
  </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>

  <script src="https://email.tl.fortawesome.com/c/eJxNjUEOgyAQAF8jR7Kw6wIHDh7sP1Cw2mgxgmn6-3JsMqc5zEQfE8dkxOY1KKMUOI3ACFKRJpSW2AAp7ontYIaxI6i7XPJVwyeVfCQ550Os3jLrGSNOLgbdAy6s0PBk2TFNjEbsfq31LB0OnX407pJa5v2faRadwSW63mn5KuLyR9j2tgx3zecanl-55R_-jjPs"></script>

</head>

<body>
  <div id="insegel-container">
    <header>
      <div id="logo-container">
          
          <a href="../index.html"><img src="../_static/img/logo.svg"></a>
          

      </div>
      <div id="project-container">
        <h1>Chris Rordens Neuropsychology Lab Documentation</h1>
      </div>
    </header>

    <div id="content-container">

      <div id="main-content-container">
        <div id="main-content-header">
          <h1>DIY Electrophysiology</h1>
        </div>
        <div id="main-content">
          
  <div class="section" id="diy-electrophysiology">
<h1>DIY Electrophysiology<a class="headerlink" href="#diy-electrophysiology" title="Permalink to this headline">¶</a></h1>
<p><strong>Note: this is an old page in an active field. Please see the links at the bottom of the page for projects that extend this work.</strong> Electrodes on the skin can be used to measure muscle (electromyography, EMG) brain (electroencephalography, EEG) and heart (electrocardiogram, ECG/EKG) activity. These electrophysiological measures are popular for clinical, research and hobbyist applications (such as brain computer interfaces). Most commercial systems are “medical grade” – these expensive systems offer high precision (16-24 bits), participant electrical isolation as well as support. On the other hand, there are numerous “hobby grade” solutions that are very inexpensive but do provide fewer features. Here we describe a “research grade” solution offering the same precision and safety of the medical systems, with the ability to add time stamps (for averaging data across trials) at a much lower cost (though without the FDA approval or support, so use these designs at your own risk).</p>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>This is an open source project for recording high quality electrophysiological data using an ADS129n compatible front-end. These chips support 4 (ADS1294), 6 (ADS1296) and 8 (ADS1298, ADS1299) channels for measurement with 24-bit precision (and if you need even more channels, you can daisy-chain multiple chips). The ADS communicates using a serial peripheral interface (SPI) link. In this design, an Arduino-compatible microcontroller translates between SPI and a Bluetooth or USB Serial Port Connection. Software in the Matlab and Processing languages allows a computer to record these serial port signals. The connection between the computer and the Arduino should be electrically isolated – either via a wireless bluetooth module (the JY-MCU sells for $8) or an electrically isolated USB connection (e.g. using an ADUM4160, $11).</p>
<p>One nice feature of the ADS129n is that they provide 24-bit precision. This allows a single hardware design to be used for very different applications (spanning EEG to ECG and EMG). In contrast, a 16-bit design needs to be tuned for the small and slow signals of scalp recorded EEG or the quick and relatively huge signals generated by superficial muscles in EMG. The chip also contains a number of sophisticated options for filtering data and acquiring ECG. The newer ADS1299 is pin-compatible with the ADS1298 providing a bit better precision but requiring more current.</p>
<p>The host computer can send signals to control the amplifier (e.g. specify the number of channels to send, the amplifier gain, sample rate, etc). The software and datasheets describe how to do this. Once the computer has specified the desired settings, a RDATAC (read data continuously) causes the amplifier to begin streaming data back until a SDATAC (stop continuous data) command is sent. In my code, the Arduino converts serial port signals directly to SPI signals, so the host software has complete control of the ads129n setup, and the code is identical for SPI or serial port communication. However, my Arduino code does alter the format for RDATAC data when transferring data from the SPI to serial port. The reason for this is that the SPI interface has a tremendous amount of bandwidth (e.g. the Teensy 3 can in theory support 21 Mbs), whereas Bluetooth connections are much more limited (e.g. inexpensive Bluetooth modules max out at about .4 Mbs). For every sample, the ADS129x SPI link will send 3+3*n bytes of data per channel, where n is 4 (ADS1294), 6 (ADS1296) and 8 (ADS1298, ADS1299). Therefore, even when you record a single channel (3 bytes), the ADS1298 sends 27 bytes of data per sample. To conserve bandwidth, this project sends 1+3*n where n is the number of ACTIVE channels. Therefore, if you set a channel to be disabled (“input shorted”) it will not require bandwidth. The first sample transmitted via the serial port is the same header byte reported by the SPI data format – this includes a signature (to help detect the first byte in each sample) and 4 bits that report the status of the 4 GPIO (general purpose inputs/outputs) that allow you to record time stamps. This sounds complicated, but the example Matlab and Processing software demonstrate how to implement these communications.</p>
</div>
<div class="section" id="implementation">
<h2>Implementation<a class="headerlink" href="#implementation" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference external" href="http://people.cas.sc.edu/rorden/SW/ads129n/ads129n.zip">Click here to download the software and related documentation</a></p></li>
</ul>
</div></blockquote>
<p>I prefer to use a <a class="reference external" href="http://www.pjrc.com/store/teensy3.html">Teensy 3.0 (T3)</a> for this application. It is inexpensive, natively supports 3.3v signals, and can support high speed (460800 bps in my experience) BlueTooth communications. The T3 has a hardware SPI port (pins 10-13) and an additional hardware serial port (pins 0 and 1) which can be used for a bluetooth module. The image shows the connections. Pins 0 and 1 are connected to the Bluetooth module. Pin 4 is connected to the ADS “START”. Pin 5 is connected to the ADS “DRDY” (data ready). Pin 10 is connected to CS (Chip Select). Pin 10 (DOUT) is connected to the ADS “DIN” (Data In) while Pin 11 (DIN) is connected to the ADS “DOUT” (Data out). Pin 13 is connected to the ADS “CLK” (clock). Optionally, connect pin 2 to PWDN (power down), pin 3 to RESET (reset) and pin 6 to CLKSEL (clock source). To omit these connections, PWDN, RESET and CLKSEL should in theory be pulled high (to 3.3v, DVDD), though with the demonstration boards they float high so can be left unconnected. Note you can always send the RESET command as an op-code from software. The T3 will also supply power to ads129n front end board – you will want to provide 5v, 3.3v and 0v (ground) in addition to linking the ads129n analog ground (AGND) to the T3 0v with a 0 Ohm 1/10 Watt resistor (which acts like a fuse to protect the participant). The Due image below shows the location of these pins on the ads129n front end boards.
This code works with an Arduino Due as well, though in my experience the BlueTooth modules are limited to around 115200 bps speeds, so it is less well suited for wireless communication. However, it is important to note that the upcoming <a class="reference external" href="https://github.com/ericherman/eeg-mouse">EEG Mouse</a> design will have the same microprocessor as the Due, so software should be optimal for that application. The essential wiring for connecting a Due to the ads1298 or ads1299 front end kits is shown on the left. Note that this figure shows the BOTTOM of the front end board (so that the header pins are accessible) and the top of the Due (so its pins are also accessible). The J4 jumper gets the 5v, 3.3v and 0v (ground) power. The J3 jumper has the signal pins – the required pins are pins are the SPI clock (SCK), Data Out (DOUT), Data In (DIN), chip select (CS), Data Ready (DRDY) and Start (START). Again, note that the Arduino and ads129n cross their DIN/DOUT – in the figure I use ‘-&amp;gt;DIN’ to show that this Due (DOUT) pin connects to the ads129n DIN pin. You must also connect the ground to of the Due to the analog ground of the ads129n – this should be done with a zero ohm 1/10 watt resistor (that acts as a fuse for protecting the participant). The diagram also shows the pins for connecting a blue tooth module (TX1, RX1) – remember the bluetooth module also requires power. Please note that for wired communications my software assumes you will connect your Due to your computer’s USB port with the Due’s fast “Native” port rather than the slow “Programmer” port (the Due has two USB sockets).
In theory, you could use other Arduino compatible devices for connecting to the ads129n devices. However, the Arduino would need to support SPI and would need to have a high speed serial port (older designs like the Uno have very slow serial connections). Two possible candidates are the Teensy 2.0 and Arduino Leonardo. However, be warned that these devices use 5 volt signals that may not work with and <strong>could even damage the ads129n</strong> (which can only handle signals up to ~3.4 volts). Therefore, you would need to add voltage dividers to each signal line. Therefore, the T3 and Due (that natively operate at 3.3v) are simpler for this application, and generally provide better performance.</p>
<a class="reference internal image-reference" href="../_images/ads_due_wiring.png"><img alt="../_images/ads_due_wiring.png" class="align-center" src="../_images/ads_due_wiring.png" style="width: 70%;" /></a>
<p>You can purchase the <a class="reference external" href="http://www.ti.com/tool/ads1298ecgfe-pdk">ADS1298</a> (ideal for ECG) or <a class="reference external" href="http://www.ti.com/tool/ads1299eegfe-pdk">ADS1299</a> (ideal for EEG) Performance Demonstration Kits for about $200. The ADS1298 kit can connect to a standard EMG connector (about $40). For EMG or EEG you will probably be better served with the ADS1299 kit connected to some <a class="reference external" href="/http://www.discountdisposables.com/cart.php?m=product_detail&amp;amp;p=59&amp;amp;lastAddedItemId=330">DIN 42-802 sockets</a>. In the near future expect to see a less expensive, smaller open source design that can be used instead of the demonstration kit (e.g. the <a class="reference external" href="https://github.com/ericherman/eeg-mouse">EEG Mouse team’s</a> REV1 board will integrate an Arduino compatible microcontroller on the same board as an ADS1299, the previous REV0 design can be <a class="reference external" href="http://oshpark.com/">fabricated</a> and used instead of the demonstration kit).</p>
</div>
<div class="section" id="testing-your-wiring">
<h2>Testing your wiring<a class="headerlink" href="#testing-your-wiring" title="Permalink to this headline">¶</a></h2>
<p>The first program to run on your Arduino/T3 is the “adsArd_hello_world” – this just makes sure that your Arduino is wired correctly to your ads129n. Load this software onto your Arduino/T3 using a USB cable (make sure to connect the cable to the ‘Native’ rather than ‘Programmer’ port if you use a Due) and then select Tools/SerialMonitor. You should see a message like “Device Type (ID Control Register): 62 Channels: 8” repeated regularly. If this works, you have wired everything correctly. If you are told the “Channels: 0” then there is a problem.</p>
</div>
<div class="section" id="upgrading-a-bluetooth-module">
<h2>Upgrading a Bluetooth Module<a class="headerlink" href="#upgrading-a-bluetooth-module" title="Permalink to this headline">¶</a></h2>
<p>Most commercial Bluetooth modules are initially programmed to only communicate at 9600bps. The included Arduino sketch “Bluetooth_Programmer_Ard” allows you to reset your module for higher speeds – in my experience inexpensive modules run at 460800bps with the Teensy 3 (and 115200 bps with the Due). You only have to run this script once – check the Arduino Serial Monitor to follow the progress. Once your module is reprogrammed it will use the new speed whenever it is restarted. Once you have reprogrammed your module, remember to put a more useful sketch onto your Arduino (for example, the adsArd sketch described below).</p>
<a class="reference internal image-reference" href="../_images/ads_Teensy3_schematic.png"><img alt="../_images/ads_Teensy3_schematic.png" class="align-center" src="../_images/ads_Teensy3_schematic.png" style="width: 70%;" /></a>
</div>
<div class="section" id="arduino-software">
<h2>Arduino Software<a class="headerlink" href="#arduino-software" title="Permalink to this headline">¶</a></h2>
<p>The Arduino sketch “adsArd” programs an Arduino-compatible device to translate the ADS129n SPI data to the USB and BlueTooth ports. This script has only been tested on the Teensy 3. We suspect it will work on the Arduino Due once the developers tune the native serial port for binary communications. Unless you use a Teensy3, you will need to edit a few lines in adsCMD to specify the pins used for SPI communication (for example, the <a class="reference external" href="http://www.pjrc.com/teensy/td_libs_SPI.html">Teensy 2 uses pins 1,2,3 for SPI communications</a> ). Once your Arduino has been re-programmed, it will act as a SPI-serial interposer whenever it is restarted. For the Teensy 3, the light on the device will be off when the ADS129n is resting, dimly lit when the ADS129n is streaming data, and will blink slowly if the Teensy is unable to detect a ADS129x (check the connections between the Teensy and the ADS129x).</p>
</div>
<div class="section" id="matlab-software">
<h2>Matlab software<a class="headerlink" href="#matlab-software" title="Permalink to this headline">¶</a></h2>
<p>The Matlab software lets the user specify the sampling rate, number of channels, and whether or not you wish to save the data. If requested, the data will be saved in BrainVision analyzer format, which you can view with the free ELEcro or EEGlab software.</p>
</div>
<div class="section" id="processing-software">
<h2>Processing software<a class="headerlink" href="#processing-software" title="Permalink to this headline">¶</a></h2>
<p>By editing the first few lines of the Processing script you can specify the sampling rate, number of channels, and whether or not you wish to save the data. If requested, the data will be saved as tab-delimited text. You can view these files with your favorite spreadsheet.</p>
<a class="reference internal image-reference" href="../_images/ads_screenshot.png"><img alt="../_images/ads_screenshot.png" class="align-center" src="../_images/ads_screenshot.png" style="width: 70%;" /></a>
</div>
<div class="section" id="links">
<h2>Links<a class="headerlink" href="#links" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference external" href="https://sites.google.com/site/chipstein/">Chipstein</a> describes probably the best hobby grade EMG (16-bit) and EEG (10-bit) around. The section on electrodes and skin preparation is vital for any electrophysiological recording.</p></li>
<li><p>Here is a link to an <a class="reference external" href="http://www.gammacardiosoft.it/openecg/">open source EU-certified 12-lead PC-based ECG.</a></p></li>
<li><p>The <a class="reference external" href="https://github.com/ericherman/eeg-mouse">EEG Mouse</a> team are developing a complete open source ADS129n hardware project with an Arduino-compatible processor built onto the board. Our intention is that the software we describe on this page can be used on this hardware to record data.</p></li>
<li><p>The <a class="reference external" href="http://www.ti.com/tool/ads1298ecgfe-pdk#buy">ADS1298ECG Front End Performance Demonstration Kit</a> includes a ADS1298 module that can be directly plugged into a Teensy 3 or other Arduino compatible device. Note that the configuration of the input channels is really optimized for ECG rather than EMG or EEG. The ads129n can do some sophisticated preprocessing of ECG data. EMG and EEG are simpler, but if you wish to use this demonstration kit for those applications you will need to use the jumpers appropriately.</p></li>
<li><p><a class="reference external" href="http://codinglab.blogspot.be/2013/07/my-heartbeat.html">Raul Aguaviva</a> describes a simple ECG system that can input into his <a class="reference external" href="https://code.google.com/p/xoscillo/">XOscillo</a> software.</p></li>
<li><p><a class="reference external" href="http://www.swharden.com/blog/2013-04-14-simple-diy-ecg-pulse-oximeter-version-2/">Scott Harden</a> describes the an elegantly simple hobby-grade ECG and optical pulse measurement system.</p></li>
<li><p><a class="reference external" href="https://sites.google.com/site/openloopproject/Home/code-valt">Josh Wojnas</a> provides plans for a simple ADS1298 hardware board.</p></li>
<li><p>StarCat provides the  <a class="reference external" href="https://starcat.io/products/hackeeg-shield/">HackEEG shield</a></p></li>
<li><p><a class="reference external" href="http://shop.openbci.com">OpenBCI</a>  provides impressive products.</p></li>
<li><p>The work described here has been extended by  <a class="reference external" href="https://github.com/adamfeuer/ADS129x-tools">Adam Feuer</a> .</p></li>
</ul>
</div></blockquote>
</div>
</div>


        </div>
      </div>

      <div id="side-menu-container">

        <div id="search" role="search">
        <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
            <input type="text" name="q" placeholder="Search..." />
            <input type="hidden" name="check_keywords" value="yes" />
            <input type="hidden" name="area" value="default" />
        </form>
</div>

        <div id="side-menu" role="navigation">

          
  
    
  
  
    <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../asl/index.html">Arterial Spin Labeling (ASL)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../blindside/index.html">Blindside</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bmp_contrast/index.html">Bitmap Contrast</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CenterOfCancellation/index.html">Center of Cancellation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../directions/index.html">Directions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../diyFmri/index.html">DIY fMRI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dti/index.html">DTI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../elecro/index.html">ELEcro</a></li>
<li class="toctree-l1"><a class="reference internal" href="../EMGRecorder/index.html">EMG Recorder</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fieldmaps/index.html">Fieldmaps</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fmriSimulator/index.html">fMRI Simulator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../jpeg-formats/index.html">JPEG Format Variations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mriconcepts/index.html">MRI Contrast</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mricro/index.html">MRIcro for macOS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gl/index.html">MRIcroGL Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gl/extract/index.html">MRIcroGL Object Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gl/gradients/index.html">MRIcroGL Gradients</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gl/shaders/index.html">MRIcroGL Shaders</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">DIY Electrophysiology</a></li>
<li class="toctree-l1"><a class="reference internal" href="../optimizingspmfsl/index.html">Optimizing FSL and SPM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../oscilloscope/index.html">Oscilloscope using Teensy or Arduino</a></li>
<li class="toctree-l1"><a class="reference internal" href="../part/index.html">Physiological Artifact Removal</a></li>
<li class="toctree-l1"><a class="reference internal" href="../psyc450/index.html">Sensation and Perception (PSYC450)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../psyc589888/index.html">Image to Inference (PSYC589/888)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pwi/index.html">Perfusion-weighted imaging (PWI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../qa/index.html">Quality Assurance (QA)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spatial/index.html">Spatial Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spm8-scripts/index.html">spmScripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../stc/index.html">Slice Time Correction (STC)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../stimsync/index.html">StimSync</a></li>
<li class="toctree-l1"><a class="reference internal" href="../stimsync-api/index.html">StimSync API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../temporal/index.html">Temporal Filtering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../publications/index.html">Publications</a></li>
</ul>

  


        </div>

        

      </div>

    </div>

<footer>
    <div id="footer-info">
        <ul id="build-details">
            
                <li class="footer-element">
                    
                        <a href="../_sources/open-source-eegecgemg/index.rst.txt" rel="nofollow"> source</a>
                    
                </li>
            

            

            
        </ul>
        <div id="credit">
            created with <a href="http://sphinx-doc.org/">Sphinx</a> and <a href="https://github.com/Autophagy/insegel">Insegel</a>

        </div>
    </div>

    <a id="menu-toggle" class="fa fa-bars" aria-hidden="true"></a>

    <script type="text/javascript">
      $("#menu-toggle").click(function() {
        $("#menu-toggle").toggleClass("toggled");
        $("#side-menu-container").slideToggle(300);
      });
    </script>

</footer> 

</div>

</body>
</html>
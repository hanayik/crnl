<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#2D2D2D" />
  
  <title>Chris Rordens Neuropsychology Lab :: DTI</title>
  

  <link rel="icon" type="image/png" sizes="32x32" href="../_static/img/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../_static/img/favicon-16x16.png">
        <link rel="index" title="Index"
              href="../genindex.html"/>

  <link rel="stylesheet" href="../_static/css/insegel.css"/>

  <script type="text/javascript">
    var DOCUMENTATION_OPTIONS = {
        URL_ROOT:'',
        VERSION:'0.1',
        LANGUAGE:'None',
        COLLAPSE_INDEX:false,
        FILE_SUFFIX:'.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
    };
  </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>

  <script src="https://email.tl.fortawesome.com/c/eJxNjUEOgyAQAF8jR7Kw6wIHDh7sP1Cw2mgxgmn6-3JsMqc5zEQfE8dkxOY1KKMUOI3ACFKRJpSW2AAp7ontYIaxI6i7XPJVwyeVfCQ550Os3jLrGSNOLgbdAy6s0PBk2TFNjEbsfq31LB0OnX407pJa5v2faRadwSW63mn5KuLyR9j2tgx3zecanl-55R_-jjPs"></script>

</head>

<body>
  <div id="insegel-container">
    <header>
      <div id="logo-container">
          
          <a href="../index.html"><img src="../_static/img/logo.svg"></a>
          

      </div>
      <div id="project-container">
        <h1>Chris Rordens Neuropsychology Lab Documentation</h1>
      </div>
    </header>

    <div id="content-container">

      <div id="main-content-container">
        <div id="main-content-header">
          <h1>DTI</h1>
        </div>
        <div id="main-content">
          
  <div class="section" id="dti">
<h1>DTI<a class="headerlink" href="#dti" title="Permalink to this headline">¶</a></h1>
<p>My <a class="reference external" href="http://www.mccauslandcenter.sc.edu/crnl/sw/tutorial/html/dti.html">basic DTI processing web page</a>  describes how to process diffusion tensor images manually using  <a class="reference external" href="http://fsl.fmrib.ox.ac.uk/fsl/fslwiki/FDT">FMRIB’s Diffusion Toolbox</a> . This page assumes you familiar with the ideas described in my basic page, so you may want to read that first. This advanced page describes how  <a class="reference external" href="http://fsl.fmrib.ox.ac.uk/fsl/fslwiki/TOPUP">FSL’s topup</a>  can be used to undistort diffusion images, and provides a matlab script for batch processing large numbers of images with topup and FDT. Topup does an incredible job unwarping images, but the current beta form involves a lot of steps and knowledge about your dataset. This script will automatically detect and separate the B0 images required by topup, simplifying topup. The effects are shown in the images on the left: the top row shows a distorted image, the middle row shows an image distorted in the opposite direction, and the bottom rom shows the pair combined after undistrotion.</p>
<div class="section" id="undistorting-dti-data">
<h2>Undistorting DTI Data<a class="headerlink" href="#undistorting-dti-data" title="Permalink to this headline">¶</a></h2>
<p>Diffusion images are acquired rapidly, and slices are typically acquired using 2D sequences (usually Echo Planar Imaging [EPI]) that acquire an entire 2D slice in a single excitation. Unfortunately, these sequences take a while to read-out the slice, and therefore any field homogeneity errors will cause spatial distortion. While scanner shimming aims to reduce field inhomogeneity, the solutions will be imperfect, particularly where there are different types of tissue present – for the brain this is particularly the sinuses near the orbital frontal cortex and regions near the ear canals. While these distortions are inevitable, we can compensate for them by acquiring two series of images that have opposite phase-encoding direction but identical in all other respects. Each of these images will end up showing distortions of identical magnitude, but opposite direction. Topup compares these two images to the nonlinear midpoint deformation between these two images. The deformation can then be applied to all the images, creating a combined image with minimal spatial distortion. Topup calculates these deformations based on the B0 images (as these are not contaminated by additional eddy current deformations of the directional scans), and then computes a mean image for each pair (positive and negative polarity) of images (so that both the B0 and directional scans are corrected). Therefore the two input series (positive and negative) create a single unwarped series that should have 1.4 times the signal to noise of either original (thanks to signal averaging).</p>
<a class="reference internal image-reference" href="../_images/topup_dti.jpg"><img alt="../_images/topup_dti.jpg" class="align-center" src="../_images/topup_dti.jpg" style="width: 70%;" /></a>
<p>When you run my script ‘ <a class="reference external" href="https://github.com/neurolabusc/nii_preprocess">dti_1_eddy</a> ’ it expects to to provide positive and negative polarity images (these should be 4D NIfTI format images). For example, if your anterior-to-postrior phased-encoded image is named named “AP.nii” and the posterior-to-anterior image is named “PA.nii” you would run something like ‘./dti_1_eddy.sh “AP” “PA”’. If all works well, the script will run TOPUP followed by Eddy. If you only provide a since image (‘./dti_1_edyy “PA.nii”’) the script will run the legacy eddy_correct (which only does a linear spatial correction). Note that users who have a graphics card set up for CUDA as well as a CUDA-capable version of FSL’s Eddy, there is a much faster way to do the same thing: my script ‘dti_1_eddy_cuda’.</p>
</div>
<div class="section" id="notes">
<h2>Notes<a class="headerlink" href="#notes" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><ul class="simple">
<li><p>By default, most Philips and GE scanners use a monopolar  <a class="reference external" href="http://www.ncbi.nlm.nih.gov/pmc/articles/PMC3003887/">Stejskal-Tanner</a>  sequence, while most Siemens use a bipolar  ` twice-refocused spin echo &lt;<a class="reference external" href="http://www.ncbi.nlm.nih.gov/pubmed/12509835">http://www.ncbi.nlm.nih.gov/pubmed/12509835</a>&gt;`_  sequence. The bipolar sequences show less distortion and are less sensitive to background gradients. The monopolar sequences are able to have more signal thanks to a shorter TE. Users of bipolar sequences will see less benefit of topup. Siemens users who want to use monopolar DTI can install the  <a class="reference external" href="http://www.cmrr.umn.edu/multiband/">Multi-Band Accelerated Pulse Sequences</a>  (even if you do not use multiband features, these sequences allow you to choose between monopolar or bipolar). These sequences are really impressive, though you may want to tune the protocols for your scanner (centers with 32-channel headcoils may want to look at the protocols  <a class="reference external" href="http://fcon_1000.projects.nitrc.org/indi/pro/eNKI_RS_TRT/FrontPage.html">Multiband Imaging Test-Retest Pilot Dataset</a> ). Setting up DTI sequences is challenging, and may be specific for your scanners (e.g. for the Siemens Trio avoid echo spacing in the range of 0.59 ms to 0.70 ms to minimize harmonic vibrations).</p></li>
<li><p>By default, most scanners only acquire a single B0 image when acquiring DTI – for example a 32 direction scan will have 33 volumes, with the first being the B0 scan. However, it is often advisable to make sure that about 1/10th of your images are B0 scans, as this will provide more accurate  <a class="reference external" href="http://www.diffusion-imaging.com/2013/02/why-do-we-acquire-b0-images-in-dti-exams.html">ADC/MD estimates</a>  as well as better topup estimates. For Siemens scanners you can create custom DiffusionVectors.txt that specify any number of gradient directions ( <a class="reference external" href="http://www.emmanuelcaruyer.com/q-space-sampling.php">online tools calculate optimal directions</a> ) and you can add extra B0 scans by inserting directions with the vector “0 0 0” at regular intervals. You can also use the command line tool ‘gps’ that is included with  <a class="reference external" href="https://fsl.fmrib.ox.ac.uk/fslcourse/lectures/practicals/fdt1/index.html#eddy">FSL</a> .</p></li>
<li><p>Topup requires you to specify the  <a class="reference external" href="http://fsl.fmrib.ox.ac.uk/fsl/fslwiki/TOPUP/ExampleTopupFollowedByApplytopup">readout time</a>  of your image. However, as long as this is identical for all your scans (and it typically is), you do not have to be precise about this value. In the case where the readout is identical for all scans an incorrect readout time will simply result in an error in the scale of the calibrated fieldmap (topup will assume the shim was better or worse than reality), but the undistortion will be identical. Since we usually acquire spin-echo DTI images with the minimum possible echo time, the readout time will be somewhat less than the echo time (TE). Consider our example DTI scan with a TE of 79.2ms – the  <a class="reference external" href="http://en.wikipedia.org/wiki/Spin_echo">refocusing pulse occurs at 39.6ms</a>  and so we cannot begin reading out until after 39.6ms and therefore must end by 118.8 ms (for a mean TE of 79.2ms). To precisely calculate the time you will want to compute readOutTime = echoSpacing * ((matrixLines*partialFourier/accelerationFactor)-1). You can find the echo spacing on the ‘Sequence’ tab of the Siemens scanner (referred to as ‘dwell time’ by some). For our example dataset the echoSpacing = 0.77ms (0.00077s), we have 90 lines of data acquired with full Fourier (partialFourier=1) and GRAPPA=2 (accelerationFactor = 2), so the readout time is 0.03388 seconds (= 0.00077 * ((90*0.5)-1). I strongly suggestion you look at the  <a class="reference external" href="https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/eddy#If_you_haven.27t_already_acquired_your_data">FSL eddy</a> web page for hints on setting up your sequence.</p></li>
</ul>
</div></blockquote>
<p>29 May 2013. Chris Rorden with suggestions from Dirk den Ouden and Svetlana Malyutina</p>
</div>
</div>


        </div>
      </div>

      <div id="side-menu-container">

        <div id="search" role="search">
        <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
            <input type="text" name="q" placeholder="Search..." />
            <input type="hidden" name="check_keywords" value="yes" />
            <input type="hidden" name="area" value="default" />
        </form>
</div>

        <div id="side-menu" role="navigation">

          
  
    
  
  
    <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../asl/index.html">Arterial Spin Labeling (ASL)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../blindside/index.html">Blindside</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bmp_contrast/index.html">Bitmap Contrast</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CenterOfCancellation/index.html">Center of Cancellation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../directions/index.html">Directions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../diyFmri/index.html">DIY fMRI</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">DTI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../elecro/index.html">ELEcro</a></li>
<li class="toctree-l1"><a class="reference internal" href="../EMGRecorder/index.html">EMG Recorder</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fieldmaps/index.html">Fieldmaps</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fmriSimulator/index.html">fMRI Simulator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../jpeg-formats/index.html">JPEG Format Variations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mriconcepts/index.html">MRI Contrast</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mricro/index.html">MRIcro for macOS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gl/index.html">MRIcroGL Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gl/extract/index.html">MRIcroGL Object Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gl/gradients/index.html">MRIcroGL Gradients</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gl/shaders/index.html">MRIcroGL Shaders</a></li>
<li class="toctree-l1"><a class="reference internal" href="../open-source-eegecgemg/index.html">DIY Electrophysiology</a></li>
<li class="toctree-l1"><a class="reference internal" href="../optimizingspmfsl/index.html">Optimizing FSL and SPM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../oscilloscope/index.html">Oscilloscope using Teensy or Arduino</a></li>
<li class="toctree-l1"><a class="reference internal" href="../part/index.html">Physiological Artifact Removal</a></li>
<li class="toctree-l1"><a class="reference internal" href="../psyc450/index.html">Sensation and Perception (PSYC450)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../psyc589888/index.html">Image to Inference (PSYC589/888)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pwi/index.html">Perfusion-weighted imaging (PWI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../qa/index.html">Quality Assurance (QA)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spatial/index.html">Spatial Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spm8-scripts/index.html">spmScripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../stc/index.html">Slice Time Correction (STC)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../stimsync/index.html">StimSync</a></li>
<li class="toctree-l1"><a class="reference internal" href="../stimsync-api/index.html">StimSync API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../temporal/index.html">Temporal Filtering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../publications/index.html">Publications</a></li>
</ul>

  


        </div>

        

      </div>

    </div>

<footer>
    <div id="footer-info">
        <ul id="build-details">
            
                <li class="footer-element">
                    
                        <a href="../_sources/dti/index.rst.txt" rel="nofollow"> source</a>
                    
                </li>
            

            

            
        </ul>
        <div id="credit">
            created with <a href="http://sphinx-doc.org/">Sphinx</a> and <a href="https://github.com/Autophagy/insegel">Insegel</a>

        </div>
    </div>

    <a id="menu-toggle" class="fa fa-bars" aria-hidden="true"></a>

    <script type="text/javascript">
      $("#menu-toggle").click(function() {
        $("#menu-toggle").toggleClass("toggled");
        $("#side-menu-container").slideToggle(300);
      });
    </script>

</footer> 

</div>

</body>
</html>